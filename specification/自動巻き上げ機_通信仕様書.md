# 自動巻き上げ機  通信仕様書

## 変更履歴
| ver | 変更日時 | 変更者 | 変更内容 |
|:----|:--------:|:------:|---------:|
| 0.1 | 2021/02/31 | gari | 新規作成 |


## 目次
- [用語](#用語)
- [基本仕様](#基本仕様)
- [IPアドレス割当](#IPアドレス割当)
- [電文フォーマット](#電文フォーマット)
- [コマンド一覧](#コマンド一覧)
  - [通信開始コマンド](#通信開始コマンド)


## 用語

- サーバ : 自動巻き上げ機の制御を管理するPC
- クライアント : 自動巻き上げ機のラズパイ


## 基本仕様

本仕様書では、クライアントとサーバ間の通信仕様を記載する。

![overview](image/OverallView.png)  

- サーバ・クライアント間の通信はTCP/IPで通信を行う。  
- IPアドレスはIPv4を使用し、各機器は全て固定アドレスを持つ。
- 通信は全て1対1で通信を行い、ブロードキャストは使用しない。  
- 初回通信や定期通信はクライアントから送信する。
- 電文フォーマットの変更に対応するため、最後に通信した際の電文フォーマットバージョンを保存する。
- 電文が化けた場合やチェックサムが異なる場合は、受信した電文を破棄する。


## IPアドレス割当

以下にそれぞれの機器のIPアドレス割当を記載する。

| 機器 | 第1-2オクテット | 第3オクテット | 第4オクテット |
|-----:|:---------------:|:-------------:|:--------------|
| サーバ | 192.168 | 0 | 1 |
| クライアント | 192.168 | ハウスNo(1～) | ハウス内ID(1～) |

クライアント機は、ハウス毎に第3オクテットを分け、
ハウス内の機器毎に順番に割り当てを行う。


## 電文フォーマット

サーバ・クライアント間の通信電文は以下のフォーマットで構成される。<br>
![command_format](image/command_format.png)

| 項目 | Size(Byte) | 説明 |
|-----:|:------------:|:-----|
| `STX` | 1 | 制御コード(0x02) |
| `送信元ID` | 2 | 送信元のIPアドレス(第3、第4オクテット) |
| `送信先ID` | 2 | 送信先のIPアドレス(第3、第4オクテット) |
| `電文番号` | 2 | 電文毎に加算していき、0xFFFF→0x0000となる<br>ResponseはRequestと同じ電文番号で行う |
| `コマンド` | 1 | コマンドID |
| `データサイズ` | 1 | データ部のサイズ |
| `データ部` | 可変長 | コマンドに応じたデータ |
| `ETX` | 1 | 制御コード(0x03) |
| `チェックサム` | 1 | CRC16-CCITT(STXからETXまで) |


## コマンド一覧

以下にサーバ・クライアント間で使用可能なコマンドを記載する。

| コマンド | コマンド名 | 説明 |
|---------:|:----------:|:-----|
| `0xF1` | 通信開始コマンド | サーバとの接続確認を行う |


### 通信開始コマンド

クライアントの起動時にサーバとの通信確認のために行う。

■クライアント→サーバへの電文(Request)  
![command_wakeup](image/command_wakeup_req.png)

| コマンド名 | 説明 |
|-----------:|:-----|
| `ハウスNo` | ハウス毎に割り当てられる番号 |
| `ハウス内ID` | ハウス内の機器にそれぞれ割り当てるID |
| `クライアント種別ID` | 下記のクライアントIDリストを参照 |

| クライアントIDリスト | クライアント種別名 |
|---------------------:|:-------------------|
| 0x01 | 自動巻き上げ機 |

■サーバ→クライアントへの電文(Response)  
サーバの状態に応じて以下のいずれかを応答する。

| コマンド名 | 説明 |
|-----------:|:-----|
| ACK | 電文を正常に処理できた場合に応答する |
| NAK | 電文の受信失敗や処理できなかった場合に応答する |

