## 中継サーバー　総括仕様書

### 変更履歴

| ver  | 変更日     | 変更者       | 変更内容 |
| ---- | ---------- | ------------ | -------- |
| 1.0  | 2021/07/03 | M.Hahshimoto | 初版     |
|      |            |              |          |
|      |            |              |          |

### 目次

- 機能概要
- 機能一覧
- 回線管理機能
- 自動巻き上げ機制御機能
- クライアント管理機能



### 機能概要

- クライアントとの接続状態管理を行う。
- クラウドから受信した窓開閉指示をクライアントへ送信する。
- クライアントIDの管理を行う。



### 機能一覧

- #### 回線管理機能

  - クライアントとの回線監視を行う。
  
- #### 巻き上げ機制御機能

  - 管理サーバーからの要求によって、クライアントに窓の開閉を指示する。

- #### クライアント管理機能

  - 管理サーバからの要求によって、クライアントIDの変更を行う。



### 回線管理機能

- クライアントから「通信開始コマンド(コマンドID:0x01)」を受信した時、以下の処理を行う。

  - FireStoreの「client_info」から受信した機器Noを検索し、検索結果によって以下処理を行う。

    - 該当機器Noが見つからない場合、クライアント種別を「0x00(未設定)」で応答(ACK)を返す。

    - 受信機器Noが「0x00」の場合、クライアント種別を「0x00(未設定)」で応答(ACK)を返す。

    - 受信したクライアントと同一機器Noがすでに登録しており、通信開始になっている場合、

      クライアント種別を「0x00(未設定)」で応答を返す。

    - 上記以外の場合、登録されているクライアント種別を応答(ACK)する。

  - FireStoreの「client_info」にクライアント情報を書き込む。

  - 機器No毎に35秒のタイマーを起動する。

  - FireStoreにアクセスできない場合や「client_info」が読み込めない場合、異常応答(NAK)を返す。

- クライアントから「状態通知コマンド(コマンドID:0x02)」を受信した時、以下の処理を行う。

  - 受信した機器Noのタイマーをリセットする。
  - クライアントへ応答(ACK)を返す。
  - 上記処理で異常が発生した場合、クライアントへ異常応答(NAK)を返す。

- 自動巻き上げ機クライアント(クライアント種別:0x02)から「状態通知コマンド(コマンドID:0x10)」を受信した場合、下記処理を行う。

  - 受信した機器Noのタイマーをリセットする。
  - 異常状態が「異常なし(0x0000)」**以外**の場合、受信した各情報をFireStoreの「client_info」に書き込む。

- 各機器Noのタイマーが切れた場合、以下の処理を行う。

  - FireStoreの「client_info」に切断状態として書き込む。
  - 対象機器Noとの回線を切断する。



### 自動巻き上げ機制御機能

- 管理サーバーからモータ動作要求を受信した場合、下記処理を行う。
  - 巻き上げ要求の場合、対象機器Noのクライアントにモーター制御要求に「全開(0x0A)」をセットし、動作制御コマンド(コマンドID:0x11)を送信する。
  - 巻き下げ要求の場合、対象機器Noのクライアントにモーター制御要求に「全閉(0x05)」をセットし、動作制御コマンド(コマンドID:0x11)を送信する。
  - モータ動作要求を受信したが、機器Noが自動巻き上げ機じゃない場合、処理を終了する。



### クライアント管理機能

- 管理サーバーからクライアントID変更コマンド(コマンドID:0x03)を受信した場合、下記処理を行う。
  - 変更対象のクライアントに変更後のクライアントIDを送信する。
- クライアントから応答受信した場合、下記処理を行う。
  - 正常応答(ACK)の場合、FireStoreの「client_info」のクライアントIDを書き換える。
  - 異常応答(NAK)の場合、処理終了する。





